## 네트워크 계층

- 네트워크 간 통신 가능하게 하는 계층
- 주요 프로토콜 : IP, ARP , ICMP, NAT, RIP, BGP, OSPF 등
- 논리적 주소인 IP가 중점
- 인터넷 사용을 하려면 사설 IP주소에서 공인 IP주소로 변경하여야 한다.
- 데이터의 단위는 패킷

## IP(Internet Protocal)

- 비신뢰성 : 최선으로 전송하지만 데이터가 원하는 곳에 전송되는지 보장하지 않음
- 비연결형 : 연결과정이 없음
- 주소 지정 : 각 기기 장치가 식별됮 수 있도록 하는 역할
- 경로 설정 : 라우팅의 경로 설정 가능
- IP주소 : 기기를 식별하기 위한 논리적 주소
- IP 주소는 10진수 뿐만 아니라 2진수로 표현가능
- 주소의 길이는 IPv4 기준으로 8bit(1옥텟)씩 32bit로 구성
- IPv4
  - 32bit
  - 10진수
  - 주소 개수 : 43억개
  - 범위 (0.0.0.0 ~ 255.255.255.255)
  - 제한적 품질
  - IPSec 별도 설치(보안기능)
- IPv6(IPv4를 대체하기 위해 등장)
  - 128bit
  - 16진수
  - 무한대에 가까움
  - 확장된 품질
  - 기본제공(보안기능)
- 네트워크 ID : 작은 네트워크를 식별하는 ID이자 호스트의 집합 대표 주소
- 호스트 ID : 호스트를 식별
- IP주소 클래스 (IPv4기준)
  - A클래스
    - 처음 8bit가 네트워크 ID 나머지 24bit가 호스트ID
    - 범위는 128.x.x.x를 넘지 않음
  - B클래스
    - 처음 16bit가 네트워크 ID 나머지 16bit가 호스트ID
    - 범위는 128.x.x.x를 넘고 192.x.x.x를 넘지 않음
  - C클래스
    - 처음 24bit가 네트워크 ID 나머지 8bit가 호스트ID
    - 범위는 192.x.x.x를 넘고 224.x.x.x를 넘지 않음
  - D클래스
    - 네트워크 ID와 호스트ID 구분이 없으며 , 멀티캐스트용으로 사용
  - E클래스
    - 지금 사용하지 않지만 특수용도 예약 주소

## 서브넷 마스크

- 너무 많은 IP주소들이 낭비되는 문제를 해결하기위해 사용
- 서브넷팅 : IP주소를 클래스로 구분하여 네트워크를 분할하는 것
- 서브넷 : 분할된 네트워크
- 서브넷 마스크 : 네트워크 ID와 호스트 ID를 식별하기 위한 값
- 네트워크 ID에 해당하는것은 1로 표기하고 호스트 ID는 0으로 표기
- 프리픽스 표기법으로 표현가능
  - 프리픽스 표기법 : 네트워크 ID의 비트 수를 슬래시(/)뒤에 표기하는 방법
- 서브넷 ID도 필요한데 원래 호스트 ID에서 앞에 4bit를 할당합니다.
- A클래스 서브넷 마스크 : 255.0.0.0
- B클래스 서브넷 마스크 : 255.255.0.0
- C클래스 서브넷 마스크 : 255.255.255.0

## IP패킷, IP헤더

- IP 헤더는 많은 정보를 가지고 있는데 위에서 부터 버전(4bit), 헤더길이(4bit), 서비스 유형(8bit), 전체 패킷 길이(16bit), ID(16bit), 플래그(3bit), 조각의 위치(13bit), TTL(8bit), 프로토콜 타입(8bit), 헤더 체크성(16bit), 출발지 IP(32bit), 목적지 IP(32bit), 옵션&데이터
  - 버전 : IP 프로토콜의 버전
  - 헤더 길이 : 헤더의 길이
  - 서비스 유형 : 패킷의 전송 우선순위 제공
  - ID(일련번호) : 전송하고자 하는 패킷을 식별하기 위해 부여하는 번호
  - 플래그 : 비트값을 통해 단편화(분할)를 금지하거나 추가
  - 조각의 위치 : 단편화(분할)된 패킷의 위치를 표현
  - TTL(Time-To-Live) : 통과가능한 라우터의 남은 수, TTL값이 0이 되기 전 목적지에 도착해야 한다.
  - 프로토콜 타입 : 역다중화에 사용되는 필드, 상위 계층 데이터에 따라 값이 달라짐
  - 헤더 체크섬 : 에러 발생 유무 검사
- IP 헤더는 20 ~ 60Byte를 가집니다.

## 라우터

- 가정 내의 네트워크에서 인터넷 네크워크로 접속하기 위해서는 ISP에서 공인 IP를 부여받은 라우터를 이용해야한다.
- 하나의 네트워크에서 다른 네트워크로 데이터를 보내는 역할
- 여러 개의 네트워크와 연결된 사이에서 패킷을 어떻게 보낼지 결정하는 역할을 한다.
- 라우팅 : 데이터를 특정 목적지까지 전송하기 위한 최적의 경로
- 데이터를 전송하면서 도착지 MAC주소와 출발지 MAC주소가 바뀜
- 도착지 IP주소와 출발지 IP주소는 그대로 TTL과 헤드 체크섬은변경

## 라우팅 프로토콜

- 라우팅 정보를 교환하기 위한 프로토콜
- 정적 라우팅 : 관리자가 직접관리
- 동적 라우팅 : 라우팅 테이블의 정보를 주기저긍로 받아 갱신
- AS(Autonomous System)을 기준으로 어떤 역할을 하느냐에 따라 내부 라우팅 프로토콜과 외부 라우팅 프로토콜
- AS란 하나의 라우팅 관리자에 의해 관리되는 네트워크 범위로 하나의 회사나 조직에서 관리하는 라우터들의 집합
- AS 간에 라우팅을 수행하는 외부 게이트웨이를 EGP(Exterior Gateway Protocopl)이라 합니다.(BGP(Border Gateway Protocol)가 있음)
- AS 내에서 라우팅을 수행하는 내부 게이트웨이를 IGP(Interior Gateway Protocol)이라 합니다.(RIP(Routing Information Protocol), OSPF(Open Shortes Path First), IGRP, EIGRP등이 있음)

## RIP(Routing Information Protocol)

- 목적지로 도착하기 까지 홉 수 정보를 저장하고 인접 라우터와 주기적으로 정보를 공유하는 방법
  - 홉 : 목적지로 도착하기 까지 거쳐야 하는 링크 또는 라우터의 수
- 거리 벡터 라우팅 프로토콜, Bellman-Ford 프로토콜
- 소규모 네트워크에 적합
- 일반적으로 30초마다 라우팅 테이블을 갱신
- 120초 동안 정보를 받지 못하면 경로 단절로 판단
- 단절된 경우 홉 수를 무한으로 표시하고 또는 홉 수 16으로 표현
- UDP 520번 포트 사용
- 직접 접속되어 있는 홉 수는 0
- 느린 수렴 현상으로 라우터 간 무한 루프가 발생한다.
- 느린 수렴 현상 해결법
  - 무한대 홉 수로 16을 사용
  - Split -Horizon : 전달하는 정보를 구분해서 전달
  - Poison-Reverse : 반대쪽 네트워크 메트릭 값을 무한으로
  - Triggered Updata : 변경 상황의 정보를 바로 전달하는 방식

## OSPF(Open Shortest Path First)

- 가장 많이 사용하는 IGP(내부 게이트웨이 프로토콜)
- 링크 상태 알고리즘 및 과고 기법 사용
- Dijkstra 알고리즘으로 최적의 경로 계산
- AS내의 여러개의 영역으로 나눈 다음, 내부의 라우터들끼리 각영역에서 라우팅 정보를 교환하는 계층적 구조를 가짐
- 경계 라우터, 백본 라우터 , 영역 경계 라우터가 있음
- 경계 라우터 한 AS의 최전방에 위치해 있음 다른 AS와 라우팅 정보를 교환하는 역할
- 백본 라우터는 백본 영역에 존재하는 라우터로, 다른 영역 경계라우터와 연결 되어 있습니다.
- 영역 경계 라우터는 영역의 경계에 위치한 라우터로, 라우팅 정보를 요약하여 연결된 백본 라우터로 전달하는 역할
- OSPF 프로토콜은 캡슐화를 통해 메시지를 전송하며 동작합니다.
- 캡슐화 되는 데이터는 IP헤더, OSPF공통해서, 특정타입 OSPF 헤더로 나뉩니다.
- 전송되는 데이터는 IP헤더로 캡슐화되고 OSPF메시지는 공통 헤더에 포함되고, 메시지는 다음과 같습니다.
  - Hello : 이웃 라우터와 정보 수립
  - Database Description : 각 링크의 요약 정보
  - Link State Request(LSR) : 링크 상태 요청
  - Link State Update(LSU) : 링크 상태 변경된 경로 정보 전송
  - Link State Acknowledgement(LSAck) : LSU에 대한 응답

## NAT(Network Address Port Translation)

- IP 주소는 이용하는 범위에 따라 공인 IP 주소 , 사설 IP주소로 나뉨
- 사설 IP에서 공인 IP를 사용하기 위해서는 NAT프로토콜을 사용
- 요청시 IP헤더의 출발지 사설 IP주소를 출발지 공인 IP주소로 변경하는 역할을 함

## ARP(Address Resolution Protocol)

- 목적지 IP주소를 통해 목적지 MAC주소를 알아내는 주소 획득 프로토콜
- IP주소와 MAC주소를 대응시키는 것을 주소 해석이라 합니다.
- 주소 해석 과정
  1. ARP 요청을 보내어 IP 주소에 대응하느 MAC주소를 질의를 합니다.(브로드캐스트 방식으로 ARP요청을 전송).
  2. 브로드 캐스트 방식으로 전송하기 때문에 질의를 받은 호스트와 받지 않은 호스트가 있을 텐데 그 중 질의를 받은 IP주소를 가진 호스트가 MAC주소를 알려줍니다. (유니캐스트 방식으로 ARP응답을 전송)
  3. 주소 해석을 완료하면 해당 IP주소와 MAC주소의 대응 정보를 ARP 캐시에 저장합니다.
- ARP 캐시
  - 획득한 목적지 정보를 20분 동안 저장
  - 저장 후 또 다시 MAC주소 요청이 오면 캐시에 저장된 정보를 사용

## ICMP(Internet Control Message Protocol)

- 목적지IP로의 데이터 전송 여부를 확인할 수 있게 해주는 프로토콜
- 에러 리포팅과 진단(질의) 기능
- 네트워크 계층 프로토콜이지만 IP헤더로 캡슐화되는 것이 특징
- ICMP헤더에는 다음과 같은 필드가 있습니다.
  - 타입 : ICMP 메시지 유형
  - 코드 : 타입 값의 내용
  - 체크섬 : 에러 검사
  - ICMP데이터(타입과 코드에 따라 가변적)
- ping : 지정한 IP주소와 통신할 수 있는지 확인하는 명령어
- 타입과 코드에 따라 ICMP 데이터가 변화하는데 자주 이용되며 중요도가 높은 타입은 다음과 같습니다.
  - 0 : Echo Reply(질의)
  - 3 : Destination Unreachable (에러)
  - 4 : Source Quench(에러)
  - 5 : Redirect(에러)
  - 8 : Echo Request(질의)
  - 11 : Time Exceeded(에러)
